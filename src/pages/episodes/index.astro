---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Episode from "../_components/Episode.astro";
import { getCollection, type CollectionEntry } from "astro:content";

const episodes = await getCollection("episodes");

type EpisodeEntry = CollectionEntry<"episodes">;

function GetEpisodeDataBySlug(
  slug: string,
): EpisodeEntry & { meta: { season: number } } {
  const ep = episodes.find((e) => e.id === slug);
  if (!ep) {
    throw new Error(`Could not find episode with slug "${slug}"`);
  }

  const [seasonSlug] = slug.split("/");
  const season = Number(seasonSlug.split("_")[1]);
  if (!season) {
    throw new Error(
      `Could not determine season for episode with slug "${slug}"`,
    );
  }
  return { ...ep, meta: { season } };
}

const sortedEpisodes = episodes
  .map((e) => GetEpisodeDataBySlug(e.id))
  .sort((a, b) => (a.data.published < b.data.published ? 1 : -1));

const seasons = Array.from(new Set(sortedEpisodes.map((ep) => ep.meta.season)));
---

<BaseLayout
  title="Episoder"
  bgFrom="oklch(98.6% 0.031 120.757)"
  bgTo="oklch(96.9% 0.015 12.422)"
  accent="oklch(59.6% 0.145 163.225)"
>
  <div class="max-w-3xl mx-auto">
    <div class="w-full flex gap-1 mb-8">
      {
        seasons.map((s) => (
          <button class="bg-emerald-700 font-semibold text-white px-4 py-1 rounded-full ring-3 ring-emerald-700 hover:cursor-pointer hover:bg-emerald-800 transition active:translate-y-[1px] hover:shadow-lg hover:scale-[1.02]">
            {`Sesong ${s}`}
          </button>
        ))
      }
    </div>

    <div class="flex flex-col gap-8 mb-8">
      {
        sortedEpisodes.map(({ id, data }) => (
          <Episode
            name={data.name}
            published={data.published}
            length={data.length}
            image={data.cover}
            description={data.description}
            id={id}
            background={data.fromColor}
            accent={data.accentColor}
            id={id}
          />
        ))
      }
    </div>
  </div>
</BaseLayout>
